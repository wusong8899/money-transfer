(function(d,F,A,x,f,c,t,P,W,C,I,U,E,_,S,R,k,q,O,me,j,G,J,H,K,z,v,Q,D,B,V){"use strict";class L extends c{}Object.assign(L.prototype,{id:c.attribute("id"),transferMoney:c.attribute("transfer_money_value"),notes:c.attribute("notes"),assignedAt:c.attribute("assigned_at"),fromUser:c.hasOne("fromUser"),targetUser:c.hasOne("targetUser")});class X{view(e){if(e.length<3||this.loading)return;t.cache.userSearchResults||(t.cache.userSearchResults=[]),this.query=e;const s=t.session.user.id();if(!t.cache.userSearchResults[this.query])this.loading=!0,t.cache.userSearchResults[this.query]=[],t.store.find("users",{filter:{q:this.query+" allows-pd"},page:{limit:5}}).then(this.pushResults.bind(this));else return[m("li",{className:"Dropdown-header"},t.translator.trans("wusong8899-transfer-money.forum.search_user_header")),t.cache.userSearchResults[this.query].map(n=>{if(s!=n.id()){const o=R(n),r=[_(o.text,this.query)];return m("li",{className:"SearchResult","data-index":"users:"+n.id()},m("a",{"data-index":"users:"+n.id()},S(n),{...o,text:void 0,children:r}))}})]}pushResults(e){e.payload.data.map(s=>{var n=t.store.getById("users",s.id);t.cache.userSearchResults[this.query].push(n)}),this.loading=!1,m.redraw()}}class Y extends E{inputUuid;oninit(e){super.oninit(e),this.inputUuid=Math.random().toString(36).substring(2)}oncreate(e){super.oncreate(e);const s=this;this.$(".Search-results").on("click",n=>{const o=this.$(".SearchResult.active");s.addRecipient(o.data("index")),s.$(".RecipientsInput").focus()}),this.$(".Search-results").on("touchstart",n=>{const o=this.$(n.target.parentNode);s.addRecipient(o.data("index")),s.$(".RecipientsInput").focus()}),$(".RecipientsInput").on("input",()=>{clearTimeout(this.typingTimer),this.doSearch=!1,this.typingTimer=setTimeout(()=>{this.doSearch=!0,m.redraw()},900)}).on("keydown",()=>{clearTimeout(this.typingTimer)}),super.oncreate(e)}view(){typeof this.searchState.getValue()>"u"&&this.searchState.setValue("");const e=this.searchState.getValue()&&this.searchState.getValue().length>=3;this.sources||(this.sources=this.sourceItems().toArray());const s=this.attrs.selected().toArray();return m("div",{role:"search",className:"Search"},m("div",{className:"RecipientsInput-selected RecipientsLabel","aria-live":"polite"},m("div",{style:"padding-bottom:10px;font-weight:bold;font-size: 14px;color: var(--text-color);"},t.translator.trans("wusong8899-transfer-money.forum.transfer-money-to-user")),s.length===0&&m("div",{style:"height:34px;cursor: default !important;",class:"transferSearchUserContainer"},t.translator.trans("wusong8899-transfer-money.forum.transfer-money-no-user-selected")),this.attrs.selected().toArray().map(n=>{const o=R(n),r=S(n),i=n.data.id;return this.attrs.selectedUsers[i]=1,m("div",{class:"transferSearchUserContainer",onclick:l=>this.removeRecipient(n,l)},m("span",{class:"transferSearchUser"},r)," ",o)})),m("div",{className:"Form-group"},m("label",{for:`transfer-money-user-search-input-${this.inputUuid}`},t.translator.trans("wusong8899-transfer-money.forum.transfer-money-search-user")),m("div",{className:"AddRecipientModal-form-input Search-input"},m("input",{id:`transfer-money-user-search-input-${this.inputUuid}`,className:k("RecipientsInput","FormControl",{open:!!this.searchState.getValue(),focused:!!this.searchState.getValue(),active:!!this.searchState.getValue(),loading:!!this.loadingSources}),type:"search",placeholder:q(t.translator.trans("wusong8899-transfer-money.forum.transfer-money-search-user-placeholder")),value:this.searchState.getValue(),oninput:n=>this.searchState.setValue(n.target.value),onfocus:()=>this.hasFocus=!0,onblur:()=>this.hasFocus=!1}),m("ul",{className:k("Dropdown-menu","Search-results","fade",{in:!!e})},this.doSearch?this.sources.map(n=>n.view(this.searchState.getValue())):O.component({size:"tiny",className:"Button Button--icon Button--link"})))))}sourceItems(){const e=new C;return e.add("users",new X),e}addRecipient(e){let s=e.split(":"),n=s[0],o=s[1],r=this.findRecipient(n,o);const i=r.data.id;this.attrs.selected().add(e,r),this.attrs.selectedUsers[i]=1,this.searchState.clear(),this.attrs.needMoney(this.getNeedMoney()),this.attrs.callback()}removeRecipient(e,s){s.preventDefault();const n=e.data.id;delete this.attrs.selectedUsers[n],this.attrs.selected().remove("users"+":"+e.id()),this.attrs.needMoney(this.getNeedMoney()),this.attrs.callback()}getNeedMoney(){return $("#moneyTransferInput").val()*Object.keys(this.attrs.selectedUsers).length}findRecipient(e,s){return t.store.getById(e,s)}}class Z extends j{static isDismissible=!1;oninit(e){super.oninit(e)}className(){return"Modal--small"}title(){return t.translator.trans("wusong8899-transfer-money.forum.transfer-money-success")}content(){return[m("div",{className:"Modal-body"},m("div",{style:"text-align:center"},G.component({style:"width:66px",className:"Button Button--primary",onclick:()=>{location.reload()}},t.translator.trans("wusong8899-transfer-money.forum.ok"))))]}}class N extends P{static isDismissible=!1;oninit(e){super.oninit(e),this.selected=I(new C),this.selectedUsers={},this.moneyName=t.forum.attribute("antoinefr-money.moneyname")||"[money]";const s=this.attrs.user;s&&(this.selected().add("users:"+s.id(),s),this.selectedUsers[s.id()]),this.recipientSearch=new W,this.needMoney=I(0)}className(){return"Modal--small"}title(){return t.translator.trans("wusong8899-transfer-money.forum.transfer-money")}content(){return m("div",{className:"Modal-body"},m("div",{className:"Form"},m("div",{style:"padding-bottom:20px;",className:"TransferMoneyModal-form"},Y.component({state:this.recipientSearch,selected:this.selected,selectedUsers:this.selectedUsers,needMoney:this.needMoney,callback:function(){m.redraw()}})),m("div",{className:"Form-group"},m("label",null,t.translator.trans("wusong8899-transfer-money.forum.current-money-amount"),this.moneyName.replace("[money]",t.session.user.attribute("money"))),m("input",{id:"moneyTransferInput",placeholder:t.translator.trans("wusong8899-transfer-money.forum.transfer-money-input-placeholder"),required:!0,className:"FormControl",type:"number",step:"any",min:"0",oninput:e=>this.moneyTransferChanged()}),m("div",{style:"padding-top:10px"},t.translator.trans("wusong8899-transfer-money.forum.need-money-amount"),m("span",{id:"needMoneyContainer"},this.moneyName.replace("[money]",this.needMoney())))),m("div",{className:"Form-group"},m("label",null,t.translator.trans("wusong8899-transfer-money.forum.transfer-money-notes")),m("textarea",{id:"moneyTransferNotesInput",maxlength:"255",className:"FormControl"})),m("div",{className:"Form-group",style:"text-align: center;"},f.component({className:"Button Button--primary",type:"submit",loading:this.loading},t.translator.trans("wusong8899-transfer-money.forum.ok"))," ",f.component({className:"Button transferMoneyButton--gray",loading:this.loading,onclick:()=>{this.hide(),typeof this.attrs.callback=="function"&&this.attrs.callback()}},t.translator.trans("wusong8899-transfer-money.forum.cancel")))))}getTotalNeedMoney(){let e=parseFloat($("#moneyTransferInput").val());return isNaN(e)&&(e=0),Object.keys(this.selectedUsers).length*e}moneyTransferChanged(){const e=this.getTotalNeedMoney(),s=this.moneyName.replace("[money]",e);$("#needMoneyContainer").text(s)}onsubmit(e){e.preventDefault();const s=t.session.user.attribute("money"),n=parseFloat($("#moneyTransferInput").val()),o=this.getTotalNeedMoney(),r=$("#moneyTransferNotesInput").val();if(o>s){t.alerts.show(U,{type:"error"},t.translator.trans("wusong8899-transfer-money.forum.transfer-error-insufficient-fund"));return}if(Object.keys(this.selectedUsers).length===0){t.alerts.show(U,{type:"error"},t.translator.trans("wusong8899-transfer-money.forum.transfer-error-no-target-user-selected"));return}if(n>0){const i={moneyTransfer:n,moneyTransferNotes:r,selectedUsers:JSON.stringify(Object.keys(this.selectedUsers))};this.loading=!0,t.store.createRecord("transferMoney").save(i).then(l=>{t.store.pushPayload(l),t.modal.show(Z),this.loading=!1,typeof this.attrs.callback=="function"&&this.attrs.callback()}).catch(l=>{this.loading=!1})}}}class ee extends J{icon(){return"fas fa-money-bill"}href(){return t.route("user.transferHistory",{username:t.session.user.username()})}content(){const e=this.attrs.notification.fromUser();return t.translator.trans("wusong8899-transfer-money.forum.notifications.user-transfer-money-to-you",{user:e})}excerpt(){const e=this.attrs.notification.subject(),s=e.attribute("transfer_money_value"),n=e.attribute("id"),r=(t.forum.attribute("antoinefr-money.moneyname")||"[money]").replace("[money]",s);return t.translator.trans("wusong8899-transfer-money.forum.notifications.user-transfer-money-details",{cost:r,id:n})}}class te extends z{view(){const{transferHistory:e}=this.attrs,s=app.session.user.id(),n=e.attribute("from_user_id"),o=e.assignedAt(),r=e.fromUser(),i=e.targetUser(),l=e.transferMoney(),w=e.notes(),M=w||app.translator.trans("wusong8899-transfer-money.forum.transfer-list-transfer-notes-none"),u=e.id(),y=app.translator.trans(s==n?"wusong8899-transfer-money.forum.transfer-money-out":"wusong8899-transfer-money.forum.transfer-money-in"),h=s==n?"color:red":"color:green",g=(app.forum.attribute("antoinefr-money.moneyname")||"[money]").replace("[money]",l);return m("div",{className:"transferHistoryContainer"},m("div",{style:"padding-top: 5px;"},m("b",null,app.translator.trans("wusong8899-transfer-money.forum.transfer-list-type"),": "),m("span",{style:h},y)," | ",m("b",null,app.translator.trans("wusong8899-transfer-money.forum.transfer-list-assign-at"),": "),o),m("div",{style:"padding-top: 5px;"},m("b",null,app.translator.trans("wusong8899-transfer-money.forum.transfer-list-id"),": "),u," | ",m("b",null,app.translator.trans("wusong8899-transfer-money.forum.transfer-list-from-user"),": "),m(D,{href:r?app.route.user(r):"#",className:"transferHistoryUser",style:"color:var(--heading-color)"},B(r)," ",V(r))," | ",m("b",null,app.translator.trans("wusong8899-transfer-money.forum.transfer-list-target-user"),": "),m(D,{href:i?app.route.user(i):"#",className:"transferHistoryUser",style:"color:var(--heading-color)"},B(i)," ",V(i))," | ",m("b",null,app.translator.trans("wusong8899-transfer-money.forum.transfer-list-transfer-amount"),": "),g," ",w&&m("span",null,"| ",m("b",null,app.translator.trans("wusong8899-transfer-money.forum.transfer-list-transfer-notes"),": "),M)))}}class se extends z{oninit(e){super.oninit(e),this.loading=!0,this.moreResults=!1,this.transferHistory=[],this.user=this.attrs.params.user,this.loadResults()}view(){return this.loading&&Q.component({size:"large"}),m("div",null,m("div",{style:"padding-bottom:10px; font-size: 24px;font-weight: bold;"},v.translator.trans("wusong8899-transfer-money.forum.transfer-money-history")),m("ul",{style:"margin: 0;padding: 0;list-style-type: none;position: relative;"},this.transferHistory.map(e=>m("li",{style:"padding-top:5px",key:e.id(),"data-id":e.id()},te.component({transferHistory:e})))),!this.loading&&this.transferHistory.length===0&&m("div",null,m("div",{style:"font-size:1.4em;color: var(--muted-more-color);text-align: center;height: 300px;line-height: 100px;"},v.translator.trans("wusong8899-transfer-money.forum.transfer-list-empty"))),this.hasMoreResults()&&m("div",{style:"text-align:center;padding:20px"},m(f,{className:"Button Button--primary",disabled:this.loading,loading:this.loading,onclick:()=>this.loadMore()},v.translator.trans("wusong8899-transfer-money.forum.transfer-list-load-more"))))}loadMore(){this.loading=!0,this.loadResults(this.transferHistory.length)}parseResults(e){return this.moreResults=!!e.payload.links&&!!e.payload.links.next,[].push.apply(this.transferHistory,e),this.loading=!1,m.redraw(),e}hasMoreResults(){return this.moreResults}loadResults(e=0){return v.store.find("transferHistory",{filter:{user:this.user.id()},page:{offset:e}}).catch(()=>{}).then(this.parseResults.bind(this))}}class ne extends H{oninit(e){super.oninit(e),this.loadUser(m.route.param("username"))}content(){return m("div",{className:"TransferHistoryPage"},se.component({params:{user:this.user}}))}}function re(){app.routes["user.transferHistory"]={path:"/u/:username/transferHistory",component:ne},d.extend(H.prototype,"navItems",function(a,e){if(app.session.user){const s=app.session.user.id(),n=this.user.id();s==n&&a.add("transferMoney",K.component({href:app.route("user.transferHistory",{username:this.user.username()}),icon:"fas fa-money-bill"},[app.translator.trans("wusong8899-transfer-money.forum.transfer-money-history")]),10)}})}const ae=10;function oe(){if(app.forum.attribute("moneyTransferClient1Customization")!=="1")return;let e=document.getElementById("transferMoneyLabelContainer");e!==null&&$(e).remove()}function ie(a,e){const s=$("#drawer").css("visibility")==="hidden",n=app.forum.attribute("moneyTransferClient1Customization");if(s===!1||n!=="1")return;$("#content .IndexPage-nav .item-nav").css("display","none"),$("#content .IndexPage-nav .item-newDiscussion").remove();let o=setInterval(function(){if(a.dom&&(clearInterval(o),a.dom!==void 0)){$("#content .IndexPage-nav .item-nav").css("display","none"),$("#content .IndexPage-nav .item-newDiscussion").remove();let r=document.getElementById("transferMoneyLabelContainer");if(r!==null)return;$("#content .IndexPage-nav .item-nav .ButtonGroup").removeClass("App-titleControl"),$("#content .IndexPage-nav .item-nav .ButtonGroup button").addClass("Button--link");let i=$("#content .IndexPage-nav .item-nav").clone();i.length>0&&($("#itemNavClone").remove(),$(i).attr("id","itemNavClone"),$(i).css("display",""),$("#header-secondary .Header-controls").prepend(i));const l=document.getElementById("app-navigation"),M=(app.forum.attribute("antoinefr-money.moneyname")||"[money]").replace("[money]",app.session.user.attribute("money"));r=document.createElement("div"),r.id="transferMoneyLabelContainer",r.className="clientCustomizeWithdrawalButtonContainer";const u=document.createElement("div");u.className="clientCustomizeWithdrawalHeaderItems clientCustomizeWithdrawalHeaderTotalMoney";const y=document.createElement("div");y.innerHTML='<span style="font-size:16px;"><i class="fab fa-bitcoin" style="padding-right: 8px;color: gold;"></i></span>'+M,y.className="clientCustomizeWithdrawalHeaderText";const h=document.createElement("div");h.innerHTML='<i class="fas fa-wallet"></i>',h.className="clientCustomizeWithdrawalHeaderIcon",u.appendChild(y),u.appendChild(h);const p=document.createElement("div");p.innerHTML=app.translator.trans("wusong8899-transfer-money.forum.withdrawal"),p.className="clientCustomizeWithdrawalHeaderItems clientCustomizeWithdrawalHeaderWithdrawal",$(p).click(function(){app.modal.show(N)});const g=document.createElement("div");g.className="clientCustomizeWithdrawalHeaderItems clientCustomizeWithdrawalHeaderUser";const b=$("#header-secondary .item-session .SessionDropdown").clone();$(b).attr("id","avatarClone"),$(b).addClass("App-primaryControl"),$(g).html(b);let T="";$(b).on("click",function(){T=T===""?"none":"",$("#content .IndexPage-nav").css("display",T)}),r.appendChild(u),r.appendChild(p),r.appendChild(g),l.appendChild(r)}},ae)}function le(){d.extend(x.prototype,"view",function(a){if(!app.session.user)return;const e=app.current.get("routeName");e&&(e!=="tags"?oe():ie(a,this.attrs.user))})}app.initializers.add("wusong8899-money-transfer",()=>{app.store.models.transferMoney=L,app.notificationComponents.transferMoney=ee,re(),le(),d.extend(A.prototype,"notificationTypes",function(a){a.add("transferMoney",{name:"transferMoney",icon:"fas fa-dollar-sign",label:app.translator.trans("wusong8899-transfer-money.forum.receive-transfer-from-user")})}),d.extend(F,"moderationControls",(a,e)=>{const s=app.forum.attribute("allowUseTranferMoney");if(app.session.user&&s){const n=app.session.user.id(),o=e.id();n!==o&&a.add("transferMoney",f.component({icon:"fas fa-money-bill",onclick:()=>app.modal.show(N,{user:e})},app.translator.trans("wusong8899-transfer-money.forum.transfer-money")))}}),d.extend(x.prototype,"items",function(a){app.session.user&&a.add("transferMoney",f.component({icon:"fas fa-money-bill",onclick:()=>{app.modal.show(N)}},app.translator.trans("wusong8899-transfer-money.forum.transfer-money")),-1)})})})(flarum.core.compat.extend,flarum.core.compat["utils/UserControls"],flarum.core.compat["components/NotificationGrid"],flarum.core.compat["forum/components/SessionDropdown"],flarum.core.compat["components/Button"],flarum.core.compat.Model,flarum.core.compat["forum/app"],flarum.core.compat["components/Modal"],flarum.core.compat["forum/states/SearchState"],flarum.core.compat["common/utils/ItemList"],flarum.core.compat["common/utils/Stream"],flarum.core.compat["common/components/Alert"],flarum.core.compat["forum/components/Search"],flarum.core.compat["common/helpers/highlight"],flarum.core.compat["common/helpers/avatar"],flarum.core.compat["common/helpers/username"],flarum.core.compat["common/utils/classList"],flarum.core.compat["common/utils/extractText"],flarum.core.compat["common/components/LoadingIndicator"],flarum.core.compat["common/models/User"],flarum.core.compat["common/components/Modal"],flarum.core.compat["common/components/Button"],flarum.core.compat["components/Notification"],flarum.core.compat["components/UserPage"],flarum.core.compat["components/LinkButton"],flarum.core.compat.Component,flarum.core.compat.app,flarum.core.compat["components/LoadingIndicator"],flarum.core.compat["components/Link"],flarum.core.compat["helpers/avatar"],flarum.core.compat["helpers/username"]);
//# sourceMappingURL=forum.js.map

module.exports={};